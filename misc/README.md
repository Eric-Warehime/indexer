# Indexer E2E tests

`make e2e` runs tests with input generated by [go-algorand `e2e_subs` tests](https://github.com/algorand/go-algorand/blob/master/test/scripts/e2e_client_runner.py).  As of writing `make e2e` is the _only_ automated validation of indexer's consumption of algod output.

The process for updating the `make e2e`'s input is manual.  Each time a go-algorand E2E test is modified, the test modifier _must_ generate new artifacts for `make e2e` consumption.  Here's the process:

| Step                                                                                                                                                                                                                                                                           | Command/Action                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Run go-algorand `e2e_subs` tests to produce new Indexer E2E inputs.<br/>* See script comments for local environment setup.<br />* Expect tests to run for ~5-10min.                                                                                                            | `bash misc/buildtestdata.sh`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Locally confirm Indexer E2E tests pass with new inputs.<br />* _Warning_:  Only use these commands locally because they're _not_ secure.<br />* The commands directly invoke `e2elive.py` to increase local iteration speed. `make e2e` spins up a Docker compose environment. <br><b>* If you are running into dependency issues please consult the e2elive.py prerequisites section below</b></br>| * `docker run -it --rm --name some-postgres -p 5432:5432 -e POSTGRES_HOST_AUTH_METHOD=trust -e POSTGRES_USER=$USER -e POSTGRES_DB=indexer_db_e2e postgres` <br/>* `python misc/e2elive.py --source-net $E2EDATA/net_done.tar.bz2 --connection-string "host=localhost port=5432 user=$USER dbname=indexer_db_e2e sslmode=disable"`<br /> * Look for `e2elive.py` output starting with: `indexer e2etest OK`.                                                                                                                                                            |
| Upload test run artifacts to S3.<br/>* Publishing to S3 streamlines running the tests for other developers and CI.<br />* If you don't have an AWS account, request artifact upload by pinging Will, Michael, or DevOps.                                                       | Run the s3 copy command provided by `misc/buildtestdata.sh` output.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `make e2e` runs on every PR. Validate results on the next CI run.                                                                                                                                                                                                              | * Find the most recent workflow starting _after_ updating the S3 bucket:  [https://app.circleci.com/pipelines/github/algorand/indexer?branch=develop&filter=all](https://app.circleci.com/pipelines/github/algorand/indexer?branch=develop&filter=all).<br/>* If successful, confirm the test used the artifact you uploaded.  Click a job link, expand _make e2e_ and search for `INFO:util:s3://`.<br />* If unsuccessful, investigate source of error.  If additional help is needed, raise in #indexer.  It is _your_ responsibility to ensure the build is fixed. |

## e2elive.py prerequisites
`e2elive.py` requires access to algorand-indexer and goal binaries. If you receive an error related to the algorand-indexer binary then you need to build the indexer from scratch by running `make` in the root of the indexer repository. This will insert a binary in the `cmd/algorand-indexer` directory, where `e2elive.py` expects it by default.

If the error is related to goal then the most likely cause is that the goal binary hasn't been installed as a package in the GOPATH system variable. Navigate to the go-algorand repository directory and run `make install`. If the error persists then run `export GOPATH=$(go env GOPATH)` followed by `export PATH=$PATH:$GOPATH/bin` in order to verify that the binary is accessible.</br>
